<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <title>OCR Tool</title>
  <!-- Styles will be added in the next step -->
  <style>
    /* Reset styles */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      width: 100%; height: 100%;
      overflow-x: hidden;
      -ms-touch-action: manipulation;
      touch-action: manipulation;
      -webkit-text-size-adjust: 100%;
    }
    #app {
      display: flex; flex-direction: column; align-items: center;
      padding: 1rem; max-width: 800px; margin: 0 auto;
    }
    .controls { display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; margin-bottom: 1rem; }
    select, button { padding: 0.5rem; font-size: 1rem; cursor: pointer; }
    .dropzone {
      width: 100%; min-height: 200px; border: 2px dashed #ccc; border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      color: #888; margin-bottom: 1rem; cursor: pointer;
    }
    .dropzone.dragover { background-color: #f0f0f0; border-color: #333; color: #333; }
    .dropzone:focus { outline: 2px solid #0066cc; }
    #preview { max-width: 100%; max-height: 300px; margin-bottom: 1rem; }
    #result {
      width: 100%; height: 200px; padding: 0.5rem; border: 1px solid #ddd;
      border-radius: 4px; overflow-y: auto; background: #fafafa; white-space: pre-wrap;
    }
    /* Debug panel styling */
    #debug-panel {
      background: #f9f9f9;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-top: 1rem;
      padding: 0.5rem;
      font-family: monospace;
      max-height: 200px;
      overflow-y: auto;
    }
    #debug-panel ul {
      list-style: none;
      padding-left: 0;
      margin-top: 0.5rem;
    }
    #debug-panel li {
      font-size: 0.85rem;
      border-bottom: 1px dotted #ddd;
      padding: 0.25rem 0;
    }
    #debug-status {
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    #clear-debug {
      background: #e0e0e0;
      border: none;
      padding: 0.25rem 0.5rem;
      margin-bottom: 0.5rem;
      cursor: pointer;
    }
    #clear-debug:hover { background: #d0d0d0; }
  </style>
</head>
<body>
  <div id="app">
    <!-- Task 3: OCR options list will go here -->
    <!-- Task 4,5,6: Image input areas will go here -->
    <div id="dropzone" class="dropzone" tabindex="0" role="button" aria-label="Upload or paste image for OCR">Drag & drop image here or click to select</div>
    <input type="file" id="file-input" accept="image/*" style="display:none" />
    <p>Or paste an image (e.g., press Print Screen and paste) anywhere on this page.</p>
    <!-- Task 7: Image preview will go here -->
    <img id="preview" src="" alt="Image preview" style="display:none" />
    <canvas id="ocr-canvas" style="display:none"></canvas>
    <!-- Task 9: OCR result display will go here -->
    <label for="result">OCR Output:</label>
    <textarea id="result" readonly placeholder="OCR result will appear here..."></textarea>
    <div class="controls">
      <label for="ocr-engine">OCR Engine:</label>
      <select id="ocr-engine">
        <option value="tesseract">Tesseract.js</option>
        <option value="ocrad">OCRAD.js</option>
        <option value="ocrspace">OCR.space API</option>
      </select>
      <div id="ocrspace-key-container" style="display:none; margin-left:1rem;">
        <label for="ocrspace-key">OCR.space API Key:</label>
        <input type="text" id="ocrspace-key" placeholder="Enter OCR.space API key" style="margin-left:0.5rem;" />
      </div>
      <label for="ocr-language">OCR Language:</label>
      <select id="ocr-language">
        <option value="eng">English</option>
        <option value="spa">Spanish</option>
        <option value="fra">French</option>
        <option value="deu">German</option>
        <option value="ita">Italian</option>
        <option value="por">Portuguese</option>
        <option value="chi_sim">Chinese (Simplified)</option>
      </select>
      <label for="debug-toggle"><input type="checkbox" id="debug-toggle"> Debug Mode</label>
    </div>
    <div id="debug-panel" style="display:none; margin-top:1rem; border:1px solid #ddd; padding:0.5rem; font-family:monospace; max-height:200px; overflow:auto;">
      <p id="debug-status">Status: </p>
      <button id="clear-debug">Clear Debug</button>
      <ul id="debug-log"></ul>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.4/dist/tesseract.min.js"></script>
  <script>
    // Prevent pinch-to-zoom on iOS Safari
    document.addEventListener('gesturestart', e => e.preventDefault());
    // OCR engine configuration
    const ocrEngines = {
      tesseract: {
        name: 'Tesseract.js',
        url: 'https://cdn.jsdelivr.net/npm/tesseract.js@2.1.4/dist/tesseract.min.js',
        loaded: true,
      },
      ocrad: {
        name: 'OCRAD.js',
        url: 'https://cdn.jsdelivr.net/npm/ocrad.js@0.0.1/ocrad.min.js',
        loaded: false,
      },
      ocrspace: {
        name: 'OCR.space API',
        loaded: true
      }
    };
    let currentEngine = 'tesseract';
    function loadOcrEngine(engineKey) {
      return new Promise((resolve, reject) => {
        const engine = ocrEngines[engineKey];
        if (!engine) {
          logDebug(`Unknown engine key: ${engineKey}`);
          setDebugStatus(`Error: Unknown engine`);
          return reject(new Error('Unknown engine'));
        }
        if (engine.loaded) {
          logDebug(`${engine.name} already loaded`);
          setDebugStatus(`${engine.name} already loaded`);
          return resolve();
        }
        logDebug(`Loading ${engine.name}...`);
        setDebugStatus(`Loading ${engine.name}...`);
        const script = document.createElement('script');
        script.src = engine.url;
        script.onload = () => {
          engine.loaded = true;
          logDebug(`${engine.name} loaded`);
          setDebugStatus(`${engine.name} loaded`);
          resolve();
        };
        script.onerror = () => {
          logDebug(`Failed to load ${engine.name}`);
          setDebugStatus(`Error loading ${engine.name}`);
          reject(new Error(`Failed to load ${engine.name}`));
        };
        document.body.appendChild(script);
      });
    }
    // Debug mode elements
    const debugToggle = document.getElementById('debug-toggle');
    const debugPanel = document.getElementById('debug-panel');
    const debugStatusEl = document.getElementById('debug-status');
    const debugLogEl = document.getElementById('debug-log');
    const clearDebugBtn = document.getElementById('clear-debug');
    // Debug functions
    function logDebug(msg) {
      if (!debugToggle.checked) return;
      const li = document.createElement('li');
      const ts = new Date().toLocaleTimeString();
      li.textContent = `[${ts}] ${msg}`;
      debugLogEl.appendChild(li);
      debugLogEl.scrollTop = debugLogEl.scrollHeight;
    }
    function setDebugStatus(text) {
      debugStatusEl.textContent = 'Status: ' + text;
    }
    // Toggle debug panel visibility
    debugToggle.addEventListener('change', () => {
      debugPanel.style.display = debugToggle.checked ? 'block' : 'none';
      if (debugToggle.checked) {
        debugLogEl.innerHTML = '';
        logDebug('Debug mode enabled');
      }
    });
    // Clear debug log button
    clearDebugBtn.addEventListener('click', () => {
      debugLogEl.innerHTML = '';
      logDebug('Debug log cleared');
    });
    // Initial OCR engine load after debug setup
    loadOcrEngine('tesseract')
      .then(() => {
        setDebugStatus(`${ocrEngines['tesseract'].name} initial load complete`);
        logDebug('Initial OCR engine loaded');
      })
      .catch(err => {
        setDebugStatus('Error loading initial OCR engine');
        logDebug(`Initial engine load failed: ${err.message}`);
      });

    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('file-input');
    const preview = document.getElementById('preview');
    const resultEl = document.getElementById('result');
    const engineSelector = document.getElementById('ocr-engine');
    const languageSelector = document.getElementById('ocr-language');
    // Debug functions
    function handleFiles(files) {
      if (!files || files.length === 0) return;
      const file = files[0];
      logDebug(`Selected file: ${file.name} (${file.type}, ${file.size} bytes)`);
      setDebugStatus(`Selected: ${file.name}`);
      const url = URL.createObjectURL(file);
      preview.onload = () => {
        logDebug(`Preview displayed: ${preview.naturalWidth}x${preview.naturalHeight}`);
        setDebugStatus(`Preview ready (${preview.naturalWidth}x${preview.naturalHeight})`);
      };
      preview.src = url;
      preview.style.display = 'block';
      resultEl.value = 'Initializing OCR...';
      const engine = currentEngine;
      if (engine === 'tesseract') {
        const language = languageSelector.value;
        logDebug(`Starting Tesseract OCR (lang=${language})`);
        setDebugStatus(`OCR: Tesseract.js (${language})`);
        Tesseract.recognize(url, language, {
          logger: m => {
            if (m.status === 'recognizing text') {
              const prog = Math.round(m.progress * 100);
              resultEl.value = `Progress: ${prog}%`;
              logDebug(`Progress: ${prog}%`);
            }
          }
        })
        .then(({ data: { text } }) => {
          logDebug(`Tesseract OCR completed, text length: ${text.length}`);
          setDebugStatus('OCR Complete');
          resultEl.value = text;
        })
        .catch(err => {
          logDebug(`Tesseract OCR error: ${err.message}`);
          setDebugStatus('Error: OCR failed');
          resultEl.value = 'Error: ' + err.message;
        });
      } else if (engine === 'ocrad') {
        logDebug('Starting OCRAD OCR');
        setDebugStatus('OCR: OCRAD.js');
        resultEl.value = 'Processing with OCRAD...';
        loadOcrEngine('ocrad').then(() => {
          logDebug('OCRAD engine loaded, starting recognition');
          setDebugStatus('OCR: OCRAD.js');
          const canvas = document.getElementById('ocr-canvas');
          const ctx = canvas.getContext('2d');
          const drawAndRecognize = () => {
            logDebug('Drawing image to canvas');
            canvas.width = preview.naturalWidth;
            canvas.height = preview.naturalHeight;
            ctx.drawImage(preview, 0, 0);
            try {
              const text = OCRAD(canvas);
              logDebug(`OCRAD OCR completed, text length: ${text.length}`);
              setDebugStatus('OCR Complete');
              resultEl.value = text;
            } catch (e) {
              logDebug(`OCRAD OCR error: ${e.message}`);
              setDebugStatus('Error: OCR failed');
              resultEl.value = 'OCRAD error: ' + e.message;
            }
          };
          if (!preview.complete) {
            preview.onload = drawAndRecognize;
          } else {
            drawAndRecognize();
          }
        }).catch(err => {
          logDebug(`Error loading OCRAD engine: ${err.message}`);
          setDebugStatus('Error: OCRAD engine load failed');
          resultEl.value = 'Error loading OCRAD: ' + err.message;
        });
      } else if (engine === 'ocrspace') {
        const key = document.getElementById('ocrspace-key').value.trim();
        if (!key) {
          logDebug('OCR.space API key missing');
          setDebugStatus('Error: API key required');
          resultEl.value = 'Error: OCR.space API key required';
          return;
        }
        logDebug(`Calling OCR.space with key length ${key.length}`);
        setDebugStatus('Calling OCR.space...');
        const form = new FormData();
        form.append('apikey', key);
        form.append('language', languageSelector.value || 'eng');
        form.append('isOverlayRequired', 'false');
        form.append('file', files[0]);
        fetch('https://api.ocr.space/parse/image', { method: 'POST', body: form })
          .then(r => r.json())
          .then(json => {
            if (json.IsErroredOnProcessing) {
              throw new Error(json.ErrorMessage.join('\n'));
            }
            const text = json.ParsedResults[0].ParsedText;
            logDebug(`OCR.space returned ${text.length} chars`);
            setDebugStatus('OCR.space result');
            resultEl.value = text;
          })
          .catch(err => {
            logDebug(`OCR.space error: ${err.message}`);
            setDebugStatus('Error: OCR.space');
            resultEl.value = 'Error: ' + err.message;
          });
      }
    }

    // Event listeners
    dropzone.addEventListener('click', () => fileInput.click());
    dropzone.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); fileInput.click(); } });
    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
    dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.classList.add('dragover'); });
    dropzone.addEventListener('dragleave', (e) => { e.preventDefault(); dropzone.classList.remove('dragover'); });
    dropzone.addEventListener('drop', (e) => { e.preventDefault(); dropzone.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
    document.addEventListener('paste', (e) => {
      if (e.clipboardData) {
        const items = e.clipboardData.items;
        for (let i = 0; i < items.length; i++) {
          const item = items[i];
          if (item.type.indexOf('image') !== -1) {
            const blob = item.getAsFile();
            handleFiles([blob]);
            break;
          }
        }
      }
    });
    engineSelector.addEventListener('change', () => {
      const selected = engineSelector.value;
      logDebug(`Engine changed to ${ocrEngines[selected].name}`);
      setDebugStatus(`Engine: ${ocrEngines[selected].name}`);
      document.getElementById('ocrspace-key-container').style.display = selected === 'ocrspace' ? 'block' : 'none';
      languageSelector.disabled = selected === 'ocrspace';
      engineSelector.disabled = true;
      resultEl.value = `Loading ${ocrEngines[selected].name}...`;
      loadOcrEngine(selected)
        .then(() => {
          currentEngine = selected;
          resultEl.value = `${ocrEngines[selected].name} loaded.`;
        })
        .catch(err => {
          resultEl.value = 'Error loading engine: ' + err.message;
        })
        .finally(() => {
          engineSelector.disabled = false;
          languageSelector.disabled = selected === 'ocrspace';
        });
    });
  </script>
</body>
</html>